---
import Navbar from "../components/Navbar.astro";
import { SITE_NAME, SITE_URL } from "../site.config";

interface Props {
  title?: string;
  description?: string;
  pathname?: string;
  noindex?: boolean;
}

const { title, description, pathname, noindex } = Astro.props as Props;

const pageTitle = title ? `${title} · ${SITE_NAME}` : SITE_NAME;
const pageDesc  = description ?? "Projetos WordPress (plugins, temas e sites) por Andrey Rocha.";
const canonical = `${SITE_URL}${pathname ?? Astro.url?.pathname ?? "/"}`;
---
<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>{pageTitle}</title>

		<meta name="description" content={pageDesc} />
		{noindex && <meta name="robots" content="noindex, nofollow" />}

		<link rel="canonical" href={canonical} />

		<!-- Open Graph / Twitter -->
		<meta property="og:type" content="website" />
		<meta property="og:title" content={pageTitle} />
		<meta property="og:description" content={pageDesc} />
		<meta property="og:url" content={canonical} />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content={pageTitle} />
		<meta name="twitter:description" content={pageDesc} />

<!-- Sinais de rede: barateiam o fetch do GA -->
  <link rel="dns-prefetch" href="https://www.googletagmanager.com">
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>

  {(
    <>
      <script is:inline>
        // DataLayer antes do script externo (não bloqueia)
        window.dataLayer = window.dataLayer || [];
        function gtag(){ dataLayer.push(arguments); }

        // Consent Mode básico (ajuste conforme sua política/LGPD)
        gtag('consent', 'default', {
          ad_storage: 'denied',
          analytics_storage: 'granted',
          wait_for_update: 500
        });

        // Fila inicial
        gtag('js', new Date());
        gtag('config', 'G-PTQKGPQ7H0', {
          // GA4 já anonimiza IP por padrão; mantenho explícito por clareza
          anonymize_ip: true,
          transport_url: undefined,  // deixe padrão; remova se não usar proxy
          send_page_view: true
        });

        // Carrega gtag.js quando o navegador estiver ocioso (menos impacto)
        const loadGA = () => {
          const s = document.createElement('script');
          s.async = true;
          s.src = 'https://www.googletagmanager.com/gtag/js?id=G-PTQKGPQ7H0';
          document.head.appendChild(s);
        };
        if ('requestIdleCallback' in window) {
          requestIdleCallback(loadGA, { timeout: 2000 });
        } else {
          setTimeout(loadGA, 1200);
        }
      </script>
    </>
  )}
  {(
	<script is:inline>
	const DNT = navigator.doNotTrack == "1" || window.doNotTrack == "1";
	if (DNT) { window['ga-disable-G-PTQKGPQ7H0'] = true; }
	</script>
  )}
	</head>
	<body>
		<Navbar />
		<slot />
	</body>
</html>

<style>
	html,
	body {
		margin: 0;
		width: 100%;
		height: 100%;
	}
:root {
  --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
               Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans",
               "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
}

html { font-family: var(--font-sans); }
</style>
